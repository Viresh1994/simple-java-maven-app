name: PostgreSQL 17 Client Test

on:
  workflow_dispatch:

jobs:
  check-psql:
    runs-on: Linux

    services:
      postgres:
        image: postgres:17   # ðŸ‘ˆ PostgreSQL 17 image
        env:
          POSTGRES_USER: github
          POSTGRES_PASSWORD: password
          POSTGRES_DB: classicmodels
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U github"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:

      - name: Checkout repository
        uses: actions/checkout@v4
    
      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
      - name: Wait for PostgreSQL to be ready
        run: |
          for i in {1..10}; do
            if pg_isready -h localhost -p 5432 -U github; then
              echo "âœ… Postgres is ready!"
              break
            fi
            echo "â³ Waiting for Postgres..."
            sleep 5
          done
      - name: Show client version
        run: psql --version

      - name: List repo files
        run: |
          echo "Listing repository files..."
          ls -R
      - name: Debug â€“ validate SQL syntax
        env:
          PGPASSWORD: password
        run: |
          echo "Running in strict mode to catch errors"
          echo "\set ON_ERROR_STOP on" | cat - scripts/postgres_classicmodels_subset.sql > scripts/sql_debug.sql
          psql -h localhost -U github -d classicmodels -f scripts/sql_debug.sql
   
      # - name: Connect to PostgreSQL and show server version
      #   run: |
      #     PGPASSWORD=password psql -h localhost -U classicmodels -d testdb -c "SELECT version();"
      - name: Run schema + data SQL file
        env:
          PGPASSWORD: password
        run: |
          echo "=== Running SQL file: scripts/postgres_classicmodels_subset.sql ==="
          psql -h localhost -U github -d classicmodels -f scripts/postgres_classicmodels_subset.sql

      - name: Run sample SELECT queries and save output
        env:
          PGPASSWORD: password
        run: |
          out="./select_output.txt"
          echo "=== Products (limit 10) ===" > $out
          # Connect to the target DB the SQL switched to (classicmodels). Use -d classicmodels if SQL created it and did \c classicmodels
          psql -h localhost -U github -d classicmodels -c "\x" -c "SELECT productcode, productname, buyprice FROM products LIMIT 10;" >> $out 2>&1
          echo -e "\n=== Customers (limit 10) ===" >> $out
          psql -h localhost -U github -d classicmodels -c "\x" -c "SELECT customernumber, customername, city, country FROM customers LIMIT 10;" >> $out 2>&1
          echo -e "\n=== Orders (limit 10) ===" >> $out
          psql -h localhost -U github -d classicmodels -c "\x" -c "SELECT ordernumber, orderdate, status, customernumber FROM orders LIMIT 10;" >> $out 2>&1
          echo "Saved select output to $out"
          cat $out

      - name: Debug â€“ count rows
        env:
          PGPASSWORD: password
        run: |
          echo "=== Table row counts ==="
          for tbl in productlines products offices employees customers payments orders orderdetails; do
            echo "Table: $tbl"
            psql -h localhost -U github -d classicmodels -c "SELECT COUNT(*) FROM $tbl;"
          done

      - name: Upload SELECT output artifact
        uses: actions/upload-artifact@v4
        with:
          name: select-output
          path: select_output.txt
