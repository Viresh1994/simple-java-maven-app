name: PostgreSQL 17 Client Test

on:
  workflow_dispatch:

jobs:
  check-psql:
    runs-on: ubuntu-latest

    env:
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      
    services:
      postgres:
        image: postgres:17   # üëà PostgreSQL 17 image
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: $POSTGRES_USER
          POSTGRES_PASSWORD: $POSTGRES_PASSWORD
          POSTGRES_DB: $POSTGRES_DB
        options: >-
          --health-cmd="pg_isready -U github"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      # - name: Wait for PostgreSQL to be ready
      #   run: |
      #     for i in {1..10}; do
      #       if pg_isready -h localhost -p 5432 -U github; then
      #         echo "‚úÖ Postgres is ready!"
      #         break
      #       fi
      #       echo "‚è≥ Waiting for Postgres..."
      #       sleep 5
      #     done
      - name: Wait for PostgreSQL to be ready
        run: |
          until pg_isready -h localhost -U "$POSTGRES_USER"; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done

      - name: Show client version
        run: psql --version

      - name: Connect and show version
        run: |
          PGPASSWORD=$POSTGRES_PASSWORD \
          psql -h localhost -U "$POSTGRES_USER" -d "$POSTGRES_DB" -c "SELECT version();"
